{% extends "booth/base.html" %}
{% load i18n static %}

{% block logout %}
<a class="btn btn-danger" href="{% url 'logout' %}">Cerrar Sesión</a>
{% endblock %}

{% block content %}
<h1>Dashboard</h1>
<p class="lead">¡Te damos la bienvenida a Decide, {{username}}!</p>
{% if no_censo %}
    <p>No has sido añadido al censo de alguna votación</p>
{% else %}
    <div class="row mt-5">
      <div class="col-12">
        <h2>Votaciones disponibles</h2>
        {% if not no_vot_dis %}
          <table class="table">
            <thead>
              <tr>
                <th scope="col">Votación</th>
                <th scope="col">Descripción</th>
                <th scope="col">Fecha de inicio</th>
              </tr>
            </thead>
            <tbody>
            {% for votacion in vot_dis %}
              <tr>
                <td><a href="{% url 'votacion' votacion.id %}">{{votacion.name}}</a></td>
                <td>{{votacion.desc}}</td>
                <td>{{votacion.start_date}}</td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p>No tiene votaciones disponibles</p>
        {% endif %}
      </div>
    </div>
    <div class="row mt-5 align-items-center">
      <div class="col-sm-9">
        <h2 >Sugerencias de votaciones</h2>
      </div>
      <div class="col-sm-3">
        <a class="btn btn-primary float-md-right float-sm-left" href="{% url 'suggesting-form' %}">Nueva sugerencia</a>
      </div>
    </div>      
    <div class="row mt-4">
      <div class="col-md-6">
        <h3>Tus sugerencias mas recientes</h3>
        {% if not no_recents_suggs %}
        <table class="table">
          <thead>
            <tr>
              <th scope="col">Título</th>
              <th scope="col">Fecha de sugerencia</th>
            </tr>
          </thead>
          <tbody>
          {% for sugerencia in recent_suggestions %}
            <tr>
              <td><a href="{% url 'suggesting-detail' sugerencia.id %}">{{sugerencia.title}}</a></td>
              <td>{{sugerencia.suggesting_date}}</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
        {% else %}
        <p>No tienes sugerencias recientes</p>
        {% endif %}
      </div>
      <div class="col-md-6">
        <h3>Tus sugerencias aprobadas</h3>
        {% if not no_approved_suggs %}
        <table class="table">
          <thead>
            <tr>
              <th scope="col">Título</th>
              <th scope="col">Fecha de sugerencia</th>
            </tr>
          </thead>
          <tbody>
          {% for sugerencia in approved_suggestions %}
            <tr>
              <td><a href="{% url 'suggesting-detail' sugerencia.id %}">{{sugerencia.title}}</a></td>
              <td>{{sugerencia.suggesting_date}}</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
        {% else %}
        <p>No tienes votaciones aprobadas</p>
        {% endif %}
      </div>
    </div>
    <div class="row mt-5">
      <div class="col-md-6">
        <h2>Votaciones por meses del año</h2>
        <div id="container1">
          <canvas id="vot_por_mes_chart"></canvas>
        </div>
      </div>
      <div class="col-md-6">
        <h2>Votaciones de cada tipo</h2>
        <div id="container2">
          <canvas id="tipos_vot_chart"></canvas>
        </div>
      </div>
    </div>
{% endif %}
{% endblock %}

{% block extrabody %}

<script>
    var app = new Vue({
        delimiters: ['[[', ']]'],
        el: '#app-booth',
        data: {
            alertShow: false,
            alertMsg: "",
            alertLvl: "info",
            csspd: false,
            csstrit: false
        },
        beforeMount() {
            this.checkDaltCookie();
        },
        methods: {
            checkDaltCookie() {
                var cookies = document.cookie.split("; ");
                cookies.forEach((c) => {
                    var cs = c.split("=");
                    if (cs[0] == 'cssMode' && cs[1]) {
                        if (cs[1] == 'pd') {
                            this.csspd = true;
                            this.csstrit = false;
                        } else if (cs[1] == 'trit') {
                            this.csspd = false;
                            this.csstrit = true;
                        }
                    }
                });
            },
            change_css(v1,v2) {
                if (v1 & !v2) {
                    this.csspd = true;
                    this.csstrit = false;
                    document.cookie = 'cssMode=pd; path=/;';
                } else if (!v1 & v2) {
                    this.csspd = false;
                    this.csstrit = true;
                    document.cookie = 'cssMode=trit; path=/;';
                } else {
                    this.csspd = false;
                    this.csstrit = false;
                    document.cookie = 'cssMode=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                }
            },
            showAlert(lvl, msg) {
                this.alertLvl = lvl;
                this.alertMsg = msg;
                this.alertShow = true;
            }
        }
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
<script>

    var config1 = {
      type: 'bar',
      data: {
        datasets: [{
          data:{{votaciones_por_meses}},
          backgroundColor: '#007bff',
          label: 'Votaciones'
        }],
        labels: {{months|safe}}
      },
      options: {
        responsive: true
      }
    };

    var config2 = {
      type: 'bar',
      data: {
        datasets: [{
          data:{{tipo_votaciones}},
          backgroundColor: '#007bff',
          label: 'Votaciones'
        }],
        labels: ['Única', 'Múltiple', 'Rango']
      },
      options: {
        responsive: true
      }
    };

    window.onload = function() {
      var ctx1 = document.getElementById('vot_por_mes_chart').getContext('2d');
      var ctx2 = document.getElementById('tipos_vot_chart').getContext('2d');
      window.myBar = new Chart(ctx1, config1);
      window.myBar = new Chart(ctx2, config2);
    };
  </script>
{% endblock %}